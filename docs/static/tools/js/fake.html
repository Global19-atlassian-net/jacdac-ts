<html>

<head>
    <style>
        body {
            font-family: monospace;
        }

        .hint {
            font-size: 80%;
        }

        #log {
            margin-top: 1rem;
        }

        #log>div {
            margin: 0.25rem;
        }

        button:not(.active) {
            opacity: 0.7;
        }

        button.active {
            font-weight: bold;
        }
    </style>
    <script>
        var process = {
            env: {}
        }
    </script>
</head>

<body>
    <h1>JACDAC/Fake</h1>
    <div>
        <button id="connect">connect</button>
        <button id="disconnect">disconnect</button>
    </div>

    <div id="log">
        <div>waiting for message...</div>
    </div>

    <script>
        function delay(millis, value) {
            return new Promise((resolve) => setTimeout(() => resolve(value), millis));
        }

        async function testLoop() {
            let lastXchg = 0
            let start = Date.now()
            let iter = 0
            let foo = 0
            for (;;) {
                for (let i = 0; i < 1000; ++i) {
                    iter++
                    
                    await Promise.resolve().then(() => foo++)

                    const now = Date.now()
                    if (lastXchg && now - lastXchg > 30) {
                        log(`${now - start}ms: slow: ${now - lastXchg}ms #${iter}`)
                        start = now
                        iter = 0
                    }
                    lastXchg = now
                }

                iter++
                await delay(1)
            }
        }


        function log(msg) {
            if (!msg)
                return
            const logDiv = document.getElementById("log");
            const line = document.createElement("div");
            line.innerText = "" + msg;
            line.style.whiteSpace = "pre-wrap";
            logDiv.appendChild(line);
            while (logDiv.childElementCount > 500)
                logDiv.firstChild.remove();
        }

        testLoop()
    </script>
</body>

</html>